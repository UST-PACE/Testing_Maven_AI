name: Prompts-ai
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: write   # <-- needed for upload/download-artifact

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: maven:3.9.6-eclipse-temurin-17-alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build Maven Project (capture logs)
        id: mvn_build
        continue-on-error: true
        run: |
          set -o pipefail
          mvn -B clean compile package -DskipTests 2>&1 | tee maven.log
          EXIT_CODE=$?
          echo "Maven exit code: $EXIT_CODE"
          echo "$EXIT_CODE" > .mvn_exit_code

      - name: Upload Maven build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-build-log
          path: maven.log
          retention-days: 14

      - name: Fail if Maven build failed
        run: |
          EXIT_CODE=$(cat .mvn_exit_code)
          echo "Maven exit code: $EXIT_CODE"
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "❌ Maven build FAILED"
            exit 1
          fi
          echo "✅ Maven build SUCCEEDED"

  docker-build:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image (capture logs)
        id: docker_build
        continue-on-error: true
        run: |
          set -o pipefail
          docker build -t demo-app:${{ github.run_number }} \
                       -t demo-app:latest \
                       . 2>&1 | tee dockerbuild.log
          EXIT_CODE=$?
          echo "Docker exit code: $EXIT_CODE"
          echo "$EXIT_CODE" > .docker_exit_code

      - name: Upload Docker build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-log
          path: dockerbuild.log
          retention-days: 14

      - name: Fail if Docker build failed
        run: |
          EXIT_CODE=$(cat .docker_exit_code)
          echo "Docker exit code: $EXIT_CODE"
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "❌ Docker build FAILED"
            exit 1
          fi
          echo "✅ Docker build SUCCEEDED"
          docker images | grep demo-app || true

  analyze-failure-with-copilot:
    needs: [build, docker-build]
    if: failure()
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
      COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Maven build log
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: maven-build-log
          path: logs/

      - name: Download Docker build log
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: docker-build-log
          path: logs/

      - name: Prepare consolidated log
        run: |
          set -euo pipefail
          LOGFILE="ci-logs.txt"

          if ls logs/*.log >/dev/null 2>&1; then
            (
              for f in logs/*.log; do
                echo "===================="
                echo "FILE: $f"
                echo "===================="
                cat "$f"
                echo
              done
            ) > "$LOGFILE"
          else
            echo "No logs found" > "$LOGFILE"
          fi

          echo "----- CI logs (first 200 lines) -----"
          head -n 200 "$LOGFILE" || true

      - name: Install Copilot CLI
        run: |
          set -euo pipefail
          export XDG_CONFIG_HOME=/tmp/copilot-config
          mkdir -p /tmp/copilot-config

          if ! command -v node >/dev/null 2>&1; then
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi

          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          npm install -g @github/copilot

          NPM_BIN="$HOME/.npm-global/bin"
          if [ -f "$NPM_BIN/copilot" ]; then
            echo "✅ Copilot CLI installed successfully"
            echo "$NPM_BIN" >> $GITHUB_PATH
            "$NPM_BIN/copilot" --version
          else
            echo "❌ ERROR: Copilot CLI not found"
            exit 1
          fi

      - name: Install GitHub CLI
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          gh --version || true

      - name: Analyze failure with Copilot (using repo prompt)
        run: |
          set -euo pipefail
          export XDG_CONFIG_HOME=/tmp/copilot-config

          echo "===== GitHub Copilot CLI: Analyzing CI failure ====="

          {
            cat .github/gh_copilot_prompts/copilot_ci_cd_error_analysis_prompts.md
            echo ""
            echo "================ CI LOGS ================"
            cat ci-logs.txt
          } > copilot-input.txt

          copilot < copilot-input.txt

      - name: Save analysis report
        run: |
          set -euo pipefail
          export XDG_CONFIG_HOME=/tmp/copilot-config

          {
            cat .github/gh_copilot_prompts/copilot_ci_cd_error_analysis_prompts.md
            echo ""
            echo "================ CI LOGS ================"
            cat ci-logs.txt
          } > copilot-input.txt

          copilot < copilot-input.txt > copilot-analysis.md

          echo "## Copilot Failure Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          head -n 150 copilot-analysis.md >> $GITHUB_STEP_SUMMARY || true

      - name: Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: copilot-analysis
          path: copilot-analysis.md
          retention-days: 14

  email-notification:
    # Use your custom runner if required; otherwise ubuntu-latest is fine.
    runs-on: eks-edopsclt-custom-runner
    needs: [build, docker-build, analyze-failure-with-copilot]
    if: always()
    steps:
      - name: Download Copilot analysis report (if exists)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: copilot-analysis
          path: .
      - name: Download Maven build log (if exists)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: maven-build-log
          path: logs/
      - name: Download Docker build log (if exists)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: docker-build-log
          path: logs/

      - name: Determine Workflow Status
        id: check_status
        run: |
          set -euo pipefail
          BUILD_STATUS="${{ needs.build.result }}"
          DOCKER_STATUS="${{ needs.docker-build.result }}"
          ANALYZE_STATUS="${{ needs.analyze-failure-with-copilot.result }}"

          # If any required job failed, mark as failure
          if [[ "$BUILD_STATUS" == "failure" || "$DOCKER_STATUS" == "failure" || "$ANALYZE_STATUS" == "failure" ]]; then
            echo "WORKFLOW_STATUS=failure" >> $GITHUB_OUTPUT
            echo "EMAIL_SUBJECT_STATUS=failed" >> $GITHUB_OUTPUT
          else
            echo "WORKFLOW_STATUS=success" >> $GITHUB_OUTPUT
            echo "EMAIL_SUBJECT_STATUS=succeeded" >> $GITHUB_OUTPUT
          fi

      - name: Determine Email Recipient
        id: determine_recipient
        run: |
          set -euo pipefail
          RECIPIENT=""
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ -n "${{ github.event.pusher.email }}" ]]; then
              RECIPIENT="${{ github.event.pusher.email }}"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ -n "${{ github.event.pull_request.user.email }}" ]]; then
              RECIPIENT="${{ github.event.pull_request.user.email }}"
            fi
          fi
          if [[ -z "$RECIPIENT" ]]; then
            RECIPIENT="${{ secrets.MAIL_RECIPIENT }}"
          fi
          echo "email_to=$RECIPIENT" >> $GITHUB_OUTPUT

      - name: Collect attachments list
        id: collect_attachments
        shell: bash
        run: |
          set -euo pipefail
          files=()
          [[ -f copilot-analysis.md ]] && files+=("copilot-analysis.md")
          [[ -f logs/maven.log ]] && files+=("logs/maven.log")
          [[ -f logs/dockerbuild.log ]] && files+=("logs/dockerbuild.log")

          printf '%s\n' "${files[@]}" > attachments_list.txt
          echo "Attachments to send:"
          cat attachments_list.txt || true

          {
            echo "attachments<<EOF"
            cat attachments_list.txt || true
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER_ADDRESS }}
          server_port: ${{ secrets.MAIL_SERVER_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '[GitHub Actions] Workflow ${{ github.workflow }} (branch ${{ github.ref_name }}) - ${{ steps.check_status.outputs.EMAIL_SUBJECT_STATUS }}'
          to: ${{ steps.determine_recipient.outputs.email_to }}
          from: GitHub Actions <no-reply@edge-ops.io>
          secure: true
          body: |
            Workflow: ${{ github.workflow }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Build Job Status: ${{ needs.build.result }}
            Docker Build Job Status: ${{ needs.docker-build.result }}
            Failure Analysis Job Status: ${{ needs.analyze-failure-with-copilot.result }}
            Overall Workflow Status: ${{ steps.check_status.outputs.WORKFLOW_STATUS }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Notes:
            - If the run failed, see the attached 'copilot-analysis.md'.
            - Build logs are attached when available.
          attachments: ${{ steps.collect_attachments.outputs.attachments }}
